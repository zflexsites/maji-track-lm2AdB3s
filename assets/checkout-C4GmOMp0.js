import{g as x,c as C,e as q,a as B,r as p}from"../js/app.js";function S(s){const t=document.getElementById("summary-items-list"),n=document.getElementById("summary-subtotal"),r=document.getElementById("summary-total"),i=document.getElementById("submit-order-btn");if(!t||!n||!r)return;if(!s||s.length===0){t.innerHTML='<p class="text-sm text-center">Votre panier est vide. <a href="/" class="underline zflex-link">Retournez faire des achats</a>.</p>',i&&(i.disabled=!0);return}t.innerHTML="";const d={};s.forEach(e=>{const a=document.createElement("div");a.className="flex justify-between text-sm",a.innerHTML=`
      <div>
        <span class="font-semibold">${e.quantity} x</span> ${e.title}
      </div>
      <span style="color: var(--text-color);">${(e.price.amount*e.quantity).toFixed(2)} ${e.price.currency}</span>
    `,t.appendChild(a);const o=e.price.currency;d[o]||(d[o]=0),d[o]+=e.price.amount*e.quantity}),n.innerHTML="",r.innerHTML="",Object.entries(d).forEach(([e,a])=>{const o=`${Number(a).toFixed(2)} ${e}`;n.innerHTML+=`<div>${o}</div>`,r.innerHTML+=`<div>${o}</div>`}),i&&(i.disabled=!1)}function T(){const s=document.getElementById("checkout-form");if(!s)return;const t=x()||[];S(t);const n=document.getElementById("submit-order-btn"),r=document.getElementById("checkout-error"),i=async d=>{var e,a,o,g,h,b;if(d.preventDefault(),!(!t||t.length===0)){n.disabled=!0,(e=n.querySelector(".btn-text"))==null||e.classList.add("hidden"),(a=n.querySelector(".btn-spinner"))==null||a.classList.remove("hidden"),r==null||r.classList.add("hidden");try{const c=new FormData(s),y={name:String(c.get("name")||""),phone:String(c.get("phone")||""),address:String(c.get("address")||""),notes:String(c.get("notes")||"")},v=JSON.parse(((o=document.getElementById("zflex-data"))==null?void 0:o.textContent)||"{}").storeId;if(!v)throw new Error("storeId manquant, impossible de continuer.");const L=t.reduce((m,I)=>m+I.price.amount*I.quantity,0),l={customer:y,items:t,total:L,currency:((g=t[0])==null?void 0:g.price.currency)||"EUR"},u=await C(l,v),f=(u==null?void 0:u.orderId)||(u==null?void 0:u.id)||null;if(!f)throw new Error("La commande a été créée mais aucun ID n'a été retourné.");q.dispatchEvent(new CustomEvent("checkout:purchase_success",{detail:{order:{id:f,total:l.total,currency:l.currency,item_count:l.items.length,items:l.items.map(m=>({id:m.id,price:m.price.amount,quantity:m.quantity}))}}})),B();const E=`/order-success/?id=${encodeURIComponent(f)}`;p&&typeof p.navigateTo=="function"?p.navigateTo(E):window.location.href=E}catch(c){const y=c instanceof Error?c.message:String(c);console.error("[Checkout] Erreur lors de la soumission de la commande:",y),r&&(r.textContent=y||"Une erreur est survenue. Veuillez réessayer.",r.classList.remove("hidden")),n.disabled=!1,(h=n.querySelector(".btn-text"))==null||h.classList.remove("hidden"),(b=n.querySelector(".btn-spinner"))==null||b.classList.add("hidden")}}};return s.addEventListener("submit",i),console.log("[Checkout] Module V3.2 (Découplé) initialisé."),{destroy:()=>{s.removeEventListener("submit",i),console.log("[Checkout] Module détruit, listeners nettoyés.")}}}export{T as initCheckout};
